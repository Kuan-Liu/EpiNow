

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE,
                      fig.width = 6, fig.height = 3,
                      message = FALSE,
                      warning = FALSE,
                      dpi = 320)
```


```{r load-packages, include = FALSE}
require(EpiNow)
require(dplyr)
require(tibble)
require(purrr)
require(stringr)
require(lubridate)
require(patchwork)
require(ggplot2)
require(knitr)
require(kableExtra)
```

```{r settings}
results_dir <- params$results_dir
target_date <- params$target_date

  
## Regions to include - based on folder names
regions <- list.files(results_dir)

## Put into alphabetical order
regions <- regions[order(regions)]

names(regions) <- regions %>% 
    stringr::str_replace_all("-", " ") %>% 
    stringr::str_to_title()


### Load data
load_data <- purrr::partial(EpiNow::load_nowcast_result,
                            results_dir = results_dir)

## Overall figures and tables
summary_figures <- 3
summary_tables <- 1
```

### Map

```{r load-results}
results <- EpiNow::summarise_results(regions, results_dir = results_dir, 
                                     target_date = target_date)
```


```{r map, fig.width = 12, fig.height = 6}

```

<br>
`r paste0("*Figure 1: Map of the expected change in daily cases based on data from the ", target_date, ".*")`

### Summary of latest reproduction number and case count estimates

```{r, fig.height = 12, fig.width = 12}
results$data %>% 
  plot_summary()
```

<br>
`r paste0("*Figure 2: Cases with date of onset on the day of report generation and the time-varying estimate of the effective reproduction number (bar = 95% credible interval) based on data from the ", target_date, ". Countries/Regions are ordered by the number of expected daily cases and shaded based on the expected change in daily cases. The dotted line indicates the target value of 1 for the effective reproduction no. required for control and a single case required fror elimination.*")`

### Reproduction numbers over time in the six countries/regions with the most cases currently

```{r summarise-bigr-plot, fig.height = 9, fig.width = 12}
regions[names(regions) %in% results$regions_by_inc[1:6]] %>% 
  plot_grid(plot_object = "bigr_eff_plot.rds", 
            results_dir = results_dir, target_date = target_date)
```

<br>
`r paste0("*Figure 3: Time-varying estimate of the effective reproduction number (light grey ribbon = 95% credible interval; dark grey ribbon = the interquartile range) based on data from the ", target_date, " in the countries/regions expected to have the highest number of incident cases. Confidence in the estimated values is indicated by shading with reduced shading corresponding to reduced confidence. The dotted line indicates the target value of 1 for the effective reproduction no. required for control.*")`


### Latest estimates summary table

```{r summary-table-1}
caption <- paste0("Latest estimates of the number of cases by date of onset, the effective reproduction number, and the doubling time for the ", target_date, " in each region included in the analysis. Based on the last 7 days of data. The 95\\% credible interval is shown for each numeric estimate. China excludes Hubei.")

knitr::kable(results$table, booktabs = TRUE, caption = ifelse(!knitr:::is_latex_output(), "", caption))  %>% 
  kableExtra::kable_styling(latex_options = c("striped", "hold_position"),
                full_width = TRUE) %>% 
  kableExtra::landscape()
```
<br>
`r if(!knitr:::is_latex_output()) paste0("*Table 1: ", caption, "*")`



`r if(show_regions) '## Regional reports {.tabset}'`

```{r generate-region-reports, include = FALSE, eval = show_regions}
region_summaries <- 1:length(regions) %>% 
  purrr::map(function(region_index) {
    index <- region_index
    region <- regions[region_index]
    region_name <- names(regions)[region_index]
   out <- knitr::knit_child(system.file("rmarkdown-templates/region-report.Rmd", 
                                        package = "EpiNow"), envir = environment()) 
  })
```


```{r print-region-reports, results="asis", eval = show_regions}
cat(paste(region_summaries, collapse = '\n'))
```

